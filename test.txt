<template>
  <div class="order-page app-container">
    <el-card shadow="never" class="summary-card">
      <template #header>
        <div class="summary-header">
          <div>
            <span class="summary-title">陪玩订单总览</span>
            <small class="summary-subtitle">掌握项目履约与支付进度</small>
          </div>
          <el-space wrap>
            <div class="summary-stat" v-for="item in summaryCards" :key="item.id">
              <p>{{ item.label }}</p>
              <h3>{{ formatNumber(item.value, item.format) }}</h3>
            </div>
          </el-space>
        </div>
      </template>

      <el-form :inline="true" :model="queryParams" class="filter-form">
        <el-form-item label="项目">
          <el-select v-model="queryParams.projectCode" placeholder="全部" clearable filterable>
            <el-option
              v-for="item in projectOptions"
              :key="item.value"
              :label="item.label"
              :value="item.value"
            />
          </el-select>
        </el-form-item>
        <el-form-item label="状态">
          <el-select v-model="queryParams.orderStatus" placeholder="全部" clearable>
            <el-option
              v-for="item in statusFilters"
              :key="item.value"
              :label="item.label"
              :value="item.value"
            />
          </el-select>
        </el-form-item>
        <el-form-item label="时间">
          <el-date-picker
            v-model="dateRange"
            type="daterange"
            range-separator="至"
            start-placeholder="开始日期"
            end-placeholder="结束日期"
            value-format="YYYY-MM-DD"
            unlink-panels
            clearable
          />
        </el-form-item>
        <el-form-item>
          <el-input
            v-model="queryParams.keyword"
            placeholder="订单号 / 老板 / 打手"
            clearable
            @keyup.enter="handleQuery"
          />
        </el-form-item>
        <el-form-item>
          <el-button type="primary" icon="Search" @click="handleQuery">搜索</el-button>
          <el-button icon="Refresh" @click="resetQuery">重置</el按钮>
        </el-form-item>
      </el-form>
    </el-card>

    <el-card shadow="never">
      <div class="table-toolbar" v-if="isManager">
        <el-space wrap>
          <el-button type="primary" @click="handleAddOrder">新建订单</el-button>
          <el-button type="danger" plain :disabled="!selectedIds.length" @click="handleBatchRemove">
            批量删除
          </el-button>
        </el-space>
      </div>
      <el-table
        v-loading="loading"
        :data="orderList"
        border
        stripe
        @selection-change="handleSelectionChange"
      >
        <el-table-column type="selection" width="50" align="center" v-if="isManager" />
        <el-table-column prop="orderNo" label="订单号" min-width="160" />
        <el-table-column prop="project" label="项目" min-width="140" />
        <el-table-column prop="mode" label="模式" min-width="140" />
        <el-table-column prop="boss" label="老板" min-width="140" v-if="isManager || isBooster" />
        <el-table-column prop="booster" label="打手" min-width="140" v-if="isManager || isBoss" />
        <el-table-column label="金额" min宽="120" v-if="isManager || isBoss">
          <template #default="scope">
            {{ formatNumber(scope.row.amount, 'currency') }}
          </template>
        </el-table-column>
        <el-table-column label="状态" min-width="130">
          <template #default="scope">
            <el-tag :type="statusTagType(scope.row.status)">
              {{ statusLabel(scope.row.status) }}
            </el-tag>
          </template>
        </el-table-column>
        <el-table-column prop="startAt" label="开局时间" min宽="160" />
        <el-table-column prop="createdAt" label="下单时间" min宽="160" />
        <el-table-column label="操作" min宽="320" fixed="right">
          <template #default="scope">
            <el-space wrap size="small">
              <el-button link type="primary" @click="openDetail(scope.row)">详情</el按钮>
              <el-button v-if="isManager" link type="primary" @click="handleEdit(scope.row)">编辑</el按钮>
              <el-button
                v-if="isManager && scope.row.status === 'dispatching'"
                link
                type="primary"
                @click="handleAssign(scope.row)"
              >
                快速派单
              </el按钮>
              <el按钮
                v-if="isManager && ['dispatching', 'waitingPay', 'confirmed'].includes(scope.row.status)"
                link
                type="danger"
                @click="handleCancel(scope.row)"
              >
                取消
              </el按钮>
              <el按钮
                v-if="isManager && ['inProgress', 'confirmed'].includes(scope.row.status)"
                link
                type="success"
                @click="handleComplete(scope.row)"
              >
                标记完成
              </el按钮>
              <el按钮
                v-if="isBoss && scope.row.status === 'waitingPay'"
                link
                type="primary"
                @click="handlePay(scope.row)"
              >
                去支付
              </el按钮>
              <el按钮
                v-if="isBooster && scope.row.status === 'confirmed'"
                link
                type="primary"
                @click="handleAccept(scope.row)"
              >
                接单
              </el按钮>
              <el按钮
                v-if="isBooster && scope.row.status === 'inProgress'"
                link
                type="warning"
                @click="handleStart(scope.row)"
              >
                开始服务
              </el按钮>
              <el按钮
                v-if="isBooster && scope.row.status === 'inProgress'"
                link
                type="success"
                @click="handleSubmit(scope.row)"
              >
                提交结果
              </el按钮>
              <el-popconfirm v-if="isManager" title="确认删除该订单？" @confirm="handleDelete(scope.row)">
                <template #reference>
                  <el-button link type="danger">删除</el按钮>
                </template>
              </el-popconfirm>
            </el-space>
          </template>
        </el-table-column>
      </el-table>

      <Pagination
        v-if="total > 0"
        v-model:page="queryParams.pageNum"
        v-model:limit="queryParams.pageSize"
        :total="total"
        @pagination="fetchOrders"
      />
    </el-card>

    <el-drawer
      v-model="detailVisible"
      :title="detailOrder ? `订单 ${detailOrder.orderNo}` : '订单详情'"
      size="520px"
    >
      <div v-if="detailOrder" class="detail-container">
        <section class="detail-section">
          <h4>基础信息</h4>
          <el-descriptions :column="1" border>
            <el-descriptions-item label="订单号">{{ detailOrder.orderNo }}</el-descriptions-item>
            <el-descriptions-item label="老板">{{ detailOrder.boss }}</el-descriptions-item>
            <el-descriptions-item label="打手">{{ detailOrder.booster || '待指派' }}</el-descriptions-item>
            <el-descriptions-item label="项目">{{ detailOrder.project }}</el-descriptions-item>
            <el-descriptions-item label="服务模式">{{ detailOrder.mode }}</el-descriptions-item>
            <el-descriptions-item label="目标段位" v-if="detailOrder.tierGoal">
              {{ detailOrder.tierGoal }}
            </el-descriptions-item>
            <el-descriptions-item label="订单金额">
              {{ formatNumber(detailOrder.amount, 'currency') }}
            </el-descriptions-item>
            <el-descriptions-item label="结算状态">
              {{ detailOrder.settlementLabel }}
            </el-descriptions-item>
            <el-descriptions-item label="支付状态">
              {{ detailOrder.payStatusLabel }}
            </el-descriptions-item>
          </el-descriptions>
        </section>

        <section class="detail-section">
          <h4>沟通信息</h4>
          <el-tag type="success" size="small" v-if="detailOrder.voice">需要语音</el-tag>
          <el-tag type="info" size="small" v-else>语音选填</el-tag>
          <p class="order-note">
            {{ detailOrder.requirement || '暂无备注' }}
            <span v-if="detailOrder.internalRemark">
              <br />内部备注：{{ detailOrder.internalRemark }}
            </span>
          </p>
        </section>

        <section class="detail-section">
          <h4>状态流转</h4>
          <el-timeline v-if="detailOrder.timeline.length">
            <el-timeline-item
              v-for="item in detailOrder.timeline"
              :key="item.label"
              :timestamp="item.time"
              :type="item.type"
            >
              {{ item.label }}
            </el-timeline-item>
          </el-timeline>
          <el-empty v-else description="暂无流转信息" />
        </section>
      </div>
      <el-empty v-else description="请选择订单" />
    </el-drawer>

    <el-dialog
      v-model="formVisible"
      :title="formModel.orderId ? '编辑订单' : '新建订单'"
      width="780px"
      destroy-on-close
    >
      <el-form ref="formRef" :model="formModel" :rules="formRules" label-width="110px">
        <el-row :gutter="16">
          <el-col :span="12">
            <el-form-item label="老板ID" prop="bossId">
              <el-input-number v-model="formModel.bossId" :min="1" :precision="0" controls-position="right" />
            </el-form-item>
          </el-col>
          <el-col :span="12">
            <el-form-item label="打手ID">
              <el-input-number
                v-model="formModel.boosterId"
                :min="0"
                :precision="0"
                controls-position="right"
                placeholder="可选填"
              />
            </el-form-item>
          </el-col>
          <el-col :span="12">
            <el-form-item label="项目编码" prop="projectCode">
              <el-select
                v-model="formModel.projectCode"
                placeholder="请输入或选择项目"
                filterable
                allow-create
                default-first-option
              >
                <el-option
                  v-for="item in projectOptions"
                  :key="item.value"
                  :label="item.label"
                  :value="item.value"
                />
              </el-select>
            </el-form-item>
          </el-col>
          <el-col :span="12">
            <el-form-item label="游戏/项目">
              <el-input v-model="formModel.gameName" placeholder="如：王者荣耀·双排" />
            </el-form-item>
          </el-col>
          <el-col :span="12">
            <el-form-item label="服务模式" prop="serviceMode">
              <el-select v-model="formModel.serviceMode" placeholder="请选择服务模式">
                <el-option
                  v-for="item in serviceModeOptions"
                  :key="item.value"
                  :label="item.label"
                  :value="item.value"
                />
              </el-select>
            </el-form-item>
          </el-col>
          <el-col :span="12">
            <el-form-item label="语音需求">
              <el-switch v-model="formModel.voiceRequired" active-value="1" inactive-value="0" />
            </el-form-item>
          </el-col>
          <el-col :span="12">
            <el-form-item label="预计时长" prop="duration">
              <el-input-number
                v-model="formModel.duration"
                :min="0.5"
                :step="0.5"
                :precision="1"
                controls-position="right"
              />
            </el-form-item>
          </el-col>
          <el-col :span="12">
            <el-form-item label="小时单价" prop="unitPrice">
              <el-input-number
                v-model="formModel.unitPrice"
                :min="0"
                :step="10"
                :precision="2"
                controls-position="right"
              />
            </el-form-item>
          </el-col>
          <el-col :span="12">
            <el-form-item label="优惠金额">
              <el-input-number
                v-model="formModel.discountAmount"
                :min="0"
                :step="10"
                :precision="2"
                controls-position="right"
              />
            </el-form-item>
          </el-col>
          <el-col :span="12">
            <el-form-item label="订单金额">
              <el-input v-model="formModel.amountDisplay" disabled />
            </el-form-item>
          </el-col>
          <el-col :span="12">
            <el-form-item label="应付金额">
              <el-input v-model="formModel.payableAmountDisplay" disabled />
            </el-form-item>
          </el-col>
          <el-col :span="12">
            <el-form-item label="订单状态">
              <el-select vmodel="formModel.orderStatus">
                <el-option
                  v-for="item in statusFilters"
                  :key="item.value"
                  :label="item.label"
                  :value="item.value"
                />
              </el-select>
            </el-form-item>
          </el-col>
          <el-col :span="12">
            <el-form-item label="支付状态">
              <el-select v-model="formModel.payStatus">
                <el-option
                  v-for="item in payStatusOptions"
                  :key="item.value"
                  :label="item.label"
                  :value="item.value"
                />
              </el-select>
            </el-form-item>
          </el-col>
          <el-col :span="12">
            <el-form-item label="结算状态">
              <el-select v-model="formModel.settlementStatus">
                <el-option
                  v-for="item in settlementStatusOptions"
                  :key="item.value"
                  :label="item.label"
                  :value="item.value"
                />
              </el-select>
            </el-form-item>
          </el-col>
          <el-col :span="12">
            <el-form-item label="开局时间">
              <el-date-picker
                v-model="formModel.startTime"
                type="datetime"
                value-format="YYYY-MM-DD HH:mm:ss"
                placeholder="选择开局时间"
                style="width: 100%;"
              />
            </el-form-item>
          </el-col>
          <el-col :span="24">
            <el-form-item label="老板备注">
              <el-input
                v-model="formModel.bossRemark"
                type="textarea"
                :rows="3"
                placeholder="补充老板诉求、语音偏好等"
              />
            </el-form-item>
          </el-col>
          <el-col :span="24">
            <el-form-item label="内部备注">
              <el-input
                v-model="formModel.internalRemark"
                type="textarea"
                :rows="3"
                placeholder="派单说明、风控提示等"
              />
            </el-form-item>
          </el-col>
        </el-row>
      </el-form>
      <template #footer>
        <el-button @click="formVisible = false">取 消</el-button>
        <el-button type="primary" :loading="formLoading" @click="submitOrderForm">保 存</el-button>
      </template>
    </el-dialog>
  </div>
</template>
